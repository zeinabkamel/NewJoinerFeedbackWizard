name: SonarQube analysis and create GH issues

on:
  push:
    branches: [ main ]
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write   # لو هننشئ GitHub issues
  checks: write

jobs:
  prepare:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure NuGet (GitHub Packages)
        shell: powershell
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # أو PAT لو محتاجة صلاحيات إضافية
        run: |
          dotnet nuget add source "https://nuget.pkg.github.com/zeinabkamel/index.json" `
            -n "GitHubPackages" `
            --username $env:GITHUB_ACTOR `
            --password "$env:NUGET_AUTH_TOKEN" `
            --store-password-in-clear-text
          dotnet restore

  sonar:
    needs: prepare
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run SonarQube scan
        uses: SonarSource/sonarqube-scan-action@v1.1.0
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=zeinabkamel_EjadaRndCICDDemo
            -Dsonar.sources=.
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }}

  create-issues:
    if: always()
    needs: sonar
    runs-on: ubuntu-latest
    steps:
      - name: Get new Sonar issues and create GitHub issues (example)
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PROJECT_KEY: zeinabkamel_EjadaRndCICDDemo
        run: |
          #!/usr/bin/env bash
          # 1) Get new/unresolved issues from Sonar
          issues_json=$(curl -s -G --user "${SONAR_TOKEN}:" "${SONAR_HOST_URL}/api/issues/search" --data-urlencode "componentKeys=${PROJECT_KEY}" --data "resolved=false" --data "ps=50")
          count=$(echo "$issues_json" | jq '.total')
          echo "Sonar reported $count open issues."
          if [ "$count" -gt 0 ]; then
            echo "$issues_json" | jq -c '.issues[]' | while read issue; do
              key=$(echo "$issue" | jq -r '.key')
              summary=$(echo "$issue" | jq -r '.message' | tr -d '\r\n' | cut -c1-240)
              file=$(echo "$issue" | jq -r '.component' | awk -F: '{print $2}')
              line=$(echo "$issue" | jq -r '.line')
              body="SonarQube issue ($key)\n\n$message\n\nFile: $file:$line\n\nSonar URL: ${SONAR_HOST_URL}/project/issues?id=${PROJECT_KEY}&issues=${key}"
              # create GitHub issue
              gh_api='https://api.github.com/repos/${{ github.repository }}/issues'
              payload=$(jq -n --arg t "$summary" --arg b "$body" '{title:$t, body:$b, labels:["sonarqube"]}')
              curl -s -X POST -H "Authorization: token ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" "${gh_api}" -d "$payload"
            done
          fi
